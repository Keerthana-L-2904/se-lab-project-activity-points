services:
  frontend:
    image: chrisscharls123/activity-points-frontend:v2
    container_name: frontend
    restart: always

    ports:
      - "4173:3000"   # host:container (Node listens on 3000)

    environment:
      API_BASE_URL: https://actpts-backend.nitc.ac.in/api
      RECAPTCHA_SITE_KEY: 6LeV-TUsAAAAABSJ6-vRnyD3zk4Z2HvhWbMa2aqT

    depends_on:
      backend:
        condition: service_started

    networks:
      - app-network

  backend:
    image: chrisscharls123/activity-points-backend:v3
    container_name: backend
    restart: on-failure
    ports:
      - "8080:8080"
    env_file:
      - backend.env
    depends_on:
      mysql:
        condition: service_healthy
      clamav:
        condition: service_started
    networks:
      - app-network

  mysql:
    image: mysql:8.0.36
    container_name: mysql
    restart: unless-stopped
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-name-resolve
      - --max_connections=500
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: student_activity_points
      MYSQL_USER: activity_user
      MYSQL_PASSWORD: activity_pass
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u root -p$MYSQL_ROOT_PASSWORD"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    mem_limit: 2g
    cpus: 2.0
    networks:
      - app-network

  mysql-backup:
    image: fradelg/mysql-cron-backup:latest
    container_name: mysql-backup
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: activity_user
      MYSQL_PASS: activity_pass
      MYSQL_DATABASE: activity_points
      CRON_TIME: "0 2 * * *"
      MAX_BACKUPS: 30
      INIT_BACKUP: 1
      GZIP_LEVEL: 9
    volumes:
      - ./backups:/backup
    networks:
      - app-network

  clamav:
    image: clamav/clamav:latest
    container_name: clamav
    restart: always
    ports:
      - "3310:3310"
    volumes:
      - clamav-db:/var/lib/clamav
    networks:
      - app-network

volumes:
  mysql-data:
    driver: local
  clamav-db:
    driver: local

networks:
  app-network:
    driver: bridge
